<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <script src="https://wagenaartje.github.io/neataptic/cdn/1.4.7/neataptic.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.11/lodash.min.js" integrity="sha256-7/yoZS3548fXSRXqc/xYzjsmuW3sFKzuvOCHd06Pmps=" crossorigin="anonymous"></script>

    <title>Car Training</title>
  </head>
  <body>

    <div class="container">
        <canvas id="level" width="1024" height="768"></canvas>
    </div>


    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

    <script>
      // the level map, which is what defines the road rules
      class Level {
        constructor(length) {
          this.length = length;


          // intersection can't be before the midpoint of the level
          let randomStart = (Math.random() / 2) + 0.5;
          this.intersectionStart = length * randomStart;
          this.intersectionEnd = this.intersectionStart + 50;
          this.length = Math.max(this.intersectionEnd, this.length);
          // 60-100kph
          this.speedLimit = (Math.random() * 40) + 60; 
        }
      }

      class Brain {
        constructor(net) {
          this.net = net;
        }

        // pass in the inputs and return the output.
        // the output layer should only have one value so return the first value in the list
        getAction(...inputs) {
          return net.activate(inputs)[0];
        }
      }

      // the car class that contains a neural network each
      class Car {
        constructor(brain, level) {
          this.brain = brain;
          this.level = level;
          this.speed = 0;
          this.acceleration = 5;
          this.maxSpeed = 150;
          this.minSpeed = 0;
          this.score = 0;
          this.active = true;
          this.position = 0;
        }

        setLevel(level) {
          this.level = level;
        }

        // the function to call in the loop 
        tick(delta) {
          let action = this.brain.getAction();
          if(action > 2/3) {
            this.accelerate(delta);
          } else if (action > 1/3) {

          } else {
            this.decelerate(delta);
          }

          this.update();
        }

        // update the car's score
        // penalize any traffic violations and inefficiencies
        update(delta) {
          // over speeding penalty factor of 5
          if(this.speed > this.level.speedLimit) {
            this.score -= (this.speedLimit - this.speed) * 5;
          }

          let isInIntersection = _.inRange(this.position, level.intersectionStart, level.intersectionEnd);
          let nextPosition = this.position + (this.speed * delta);
          let nextIsInIntersection = _.inRange(this.position, level.intersectionStart, level.intersectionEnd);

          // crossed the intersection, penalize 50 pts
          if(!isInIntersection && nextIsInIntersection) {
            this.score -= 50;
          }

          this.position = nextPosition;
        }

        accelerate(delta) {
          this.speed += this.acceleration * delta;
        }

        decelerate(delta) {
          this.speed -= this.acceleration * delta;
        }

        efficiency() {
          return Math.sin((90 * Math.PI * speed / 180)/80);
        }


      }

      // set up the neural network architecture
      var net = new neataptic.architect.Perceptron(8, 12, 12, 1);

      // set up the global variables
      const POPULATION_COUNT = 16;
      const PARENT_COUNT     = 4;

      // create the initial population of cars
      let level = new Level(800);
      let population = [...Array(POPULATION_COUNT)].map(i => {
        let net = new neataptic.architect.Perceptron(8, 12, 12, 1);
        let brain = new Brain(net);
        return new Car(brain, _.clone(level));
      });


      let simulationRunning = true;
      let lastTick = new Date();

      let simulation = setInterval(function() {
        let currentTick = new Date();
        let delta = currentTick - lastTick;
        population.map(car => {
          car.update(delta)
        });
        lastTick = currentTick;
        console.log(`Last Run: ${currentTick.toLocaleTimeString()} at ${delta}ms`);
      }, 33.3333);

      function stopSimulation() {
        clearInterval(simulation);
      }

      console.log(`Application stopped at: ${Date.now()}`);
    </script>
  </body>
</html>